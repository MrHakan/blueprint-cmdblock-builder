<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <base href="/blueprint-cmdblock-builder/">
    <title>Command Block Assembler by GalSergey</title>
    <link rel="icon" href="https://styles.redditmedia.com/t5_6aviyc/styles/profileIcon_msenduashsw81.jpg"
        type="image/png">
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.2.2/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/min/vs/loader.js"></script>

    <!-- Common Styles and Scripts -->
    <link rel="stylesheet" href="./styles/common.css">
    <script src="./scripts/common.js"></script>

    <!-- Page-specific Scripts -->
    <script src="./scripts/monaco/gallab_cb_language.js"></script>
    <script src="./scripts/monaco/key_commands.js"></script>
    <script src="./scripts/snbt.js"></script>
    <script src="./scripts/blueprint/command-change-detector.js"></script>
    <script src="./scripts/sync-manager.js"></script>
    <!-- Page-specific Styles -->
    <style>
        /* Command Block Assembler specific styles */
        #myInput {
            font-family: 'Courier New', monospace;
            height: 90vh;
            display: block;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 5px;
            resize: none;
            position: sticky;
            top: 0;
            background-color: #444;
            border-bottom: 1px solid #000;
            font-size: 16px;
            color: #fff;
        }

        #Output {
            font-family: 'Courier New', monospace;
            height: 40vh;
            display: block;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 5px;
            resize: none;
            position: sticky;
            top: 0;
            background-color: #444;
            border-bottom: 1px solid #000;
            font-size: 16px;
            padding: 10px;
            color: #fff;
        }

        #myInput input,
        #spawn_egg_type,
        #archiveName input,
        #description input,
        #packFormatSelect select,
        #dataFormatVersion input {
            width: 260px;
            padding: 8px;
            box-sizing: border-box;
            background-color: #555;
            color: #fff;
            border: none;
        }

        #spawn_egg_type {
            width: 220px;
        }

        #facing {
            height: 31px;
            background: rgb(85, 85, 85);
            color: white;
            border-color: rgb(85, 85, 85);
            margin-right: 4px;
        }
    </style>
</head>

<body>
    <header>
        <div class="links">
            <div class="icon">
                <a href="./index.html">
                    <img src="./assets/skin.png" class="skin">
                    <img src="./assets/glasses.png" class="glasses">
                </a>
            </div>
            <nav class="header-links">
                <a href="./">Datapack Assembler</a>
                <a href="./index.html">Datapack Assembler</a>
                <a href="./blueprint.html" style="color: #4a9eff">Blueprint Editor</a>
                <a href="./item" style="cursor: not-allowed; opacity: 0.5; pointer-events: none;">Item Components
                    Viewer</a>
            </nav>
        </div>
        <div class="library">
            <div id="exampleSelector">
                <label for="authorSelect">Author:</label>
                <select id="authorSelect"
                    style="display: inline-block; width: 128px; height: 31px; background: rgb(85, 85, 85); color: white; border-color: rgb(85, 85, 85); margin-right: 4px;"></select>
                <label for="exampleSelect">Select Example:</label>
                <select id="exampleSelect"
                    style="display: inline-block; width: 260px; height: 31px; background: rgb(85, 85, 85); color: white; border-color: rgb(85, 85, 85); margin-right: 4px;"></select>
                <button class="load-example" id="openExampleButton" onclick="loadExample(event)">Load Example</button>
            </div>
        </div>
    </header>
    <div id="myInput" class="code-input" name="myInput">
        <span class="placeholder" id="placeholder"></span>
    </div>
    <textarea readonly id="Output" name="Output" placeholder="Output"></textarea>
    <div id="Settings">
        <div class="extra">
            <label for="spawn_egg" title="Thanks to WitherGod360 for the idea!">TEST</label>
        </div>
        <div class="container">
            <div>
                <label for="spawn_egg" title="Thanks to WitherGod360 for the idea!">Make Spawn Egg:</label>
                <input type="checkbox" id="spawn_egg" title="Thanks to WitherGod360 for the idea!">
                <input style="width: 220px;" list="spawn_egg_list" id="spawn_egg_type" placeholder="bat_spawn_egg">
                <datalist id="spawn_egg_list"></datalist>
                <label for="facing">Facing:</label>
                <select id="facing"
                    style="display: inline-block; height: 31px; background: rgb(85, 85, 85); color: white; border-color: rgb(85, 85, 85); margin-right: 4px;">
                    <option value="" selected>North (-Z)</option>
                    <option value="facing=south">South (+Z)</option>
                    <option value="facing=west">West (-X)</option>
                    <option value="facing=east">East (+X)</option>
                </select>
                <button onclick="createOneCommand(event)">Get One Command</button>
                <button id="resetButton" onclick="resetValues()">Reset to Default</button>
                <button class="import-button" onclick="importCommands()">Import</button>
                <input type="text" id="copyLink" class="copyLink" value="http://far.ddns.me/?share=kiycXOKPwg" size="35"
                    readonly>
                <button class="share-button" onclick="sendShare(event)">Share</button>
            </div>
        </div>
    </div>
    <div id="footer">
        <p id="patreon"><a href="https://www.patreon.com/GalSergey" target="_blank">Patreon</a></p>
        <p>Please report any bugs on the site to<a href="https://www.reddit.com/user/GalSergey"
                target="_blank">GalSergey</a>|<a href="https://modrinth.com/user/GalSergey" target="_blank">My
                datapacks</a></p>
    </div>
    <script>
        // ===========================================
        // COMMAND BLOCK ASSEMBLER - MAIN SCRIPT
        // ===========================================

        // Initialize patreon support
        const patreonsFormat = "Mr. Papaveraceae"
        updatePatreonsElement('command_blocks');

        const maskMappings = {}
        const placeholder = document.querySelector('.placeholder');
        placeholder.setAttribute('placeholder', 'Enter the commands...\nFor example:\n# In chat\nsay Hello World!\n\n# Command block\n[RUA] give @a hugs[max_stack_size=99] 99');
        let editorLoaded = false;
        async function load_editor() {
            if (editorLoaded) return;
            editorLoaded = true;

            await fetch('https://raw.githubusercontent.com/misode/mcmeta/refs/heads/summary/commands/data.min.json')
                .then(res => res.json())
                .then(data => {
                    commands_structure = data;
                });

            await fetch('https://raw.githubusercontent.com/misode/mcmeta/refs/heads/summary/registries/data.min.json')
                .then(res => res.json())
                .then(data => {
                    registries = data;
                })
            await fetch('https://raw.githubusercontent.com/misode/mcmeta/refs/heads/summary/block_definitions/data.min.json')
                .then(res => res.json())
                .then(data => {
                    block_definitions = data;
                })

            initializeMonacoEditor(function () {
                window.registerDatapackLanguage(monaco);
                editor = createMonacoEditor(document.getElementById('myInput'), {
                    lineNumbers: gallabLineNumbers
                });
                window.registerEditorCommands(editor);

                editor.onDidChangeModelContent(() => {
                    handleInputChange({ target: { name: "myInput", value: editor.getValue() } });
                    // Sync to Blueprint via SyncManager
                    if (window.syncManager) {
                        syncManager.updateCommands(editor.getValue());
                    }
                });

                // Load from SyncManager first, then fallback to old storage
                let initialValue = '';
                if (window.syncManager) {
                    initialValue = syncManager.getCommands();
                }
                if (!initialValue) {
                    initialValue = getStorage('myInput') || '';
                }
                if (initialValue) {
                    editor.setValue(initialValue);
                }
                inputFields = document.querySelectorAll('input')
                inputFields.forEach((inputField) => {
                    inputField.addEventListener('input', handleInputChange);
                    const storedValue = getStorage(inputField.id);
                    if (storedValue !== null) {
                        inputField.value = storedValue;
                    }
                });

                const layoutInfo = editor.getLayoutInfo();
                const lineHeight = editor.getOption(monaco.editor.EditorOption.lineHeight);
                const lineTop = editor.getTopForLineNumber(1);
                const width = editor.getLayoutInfo().contentWidth;

                placeholder.style.top = `${lineTop}px`;
                placeholder.style.left = `${layoutInfo.contentLeft}px`;
                placeholder.style.lineHeight = `${lineHeight}px`;
                placeholder.style.width = `${width}px`;
                placeholder.style.display = storedTextareaValue ? 'none' : 'block';

                const urlParams = new URLSearchParams(window.location.search);
                const categoryFromURL = urlParams.get('category');
                const exampleFromURL = urlParams.get('example');
                const shareFromURL = urlParams.get('share');

                if (categoryFromURL && exampleFromURL) {
                    loadExample(event = event.NONE, categoryFromURL.replace(/_/g, ' '), exampleFromURL.replace(/_/g, ' '));
                } else if (shareFromURL) {
                    loadShare(shareFromURL);
                };
                const newUrl = window.location.href.split('?')[0];
                window.history.pushState({}, document.title, newUrl);
            });
        }

        function getHash(hash) {
            let hashes;
            try {
                hashes = JSON.parse(localStorage['hashes']);
            } catch {
                localStorage['hashes'] = '{}';
                hashes = {};
            }
            return hashes[hash];
        }

        function setHash(hash, link) {
            let hashes;
            try {
                hashes = JSON.parse(localStorage['hashes']);
            } catch {
                localStorage['hashes'] = '{}';
                hashes = {};
            }
            hashes[hash] = link;
            localStorage['hashes'] = JSON.stringify(hashes);
        }

        var examplesByCategory = {
            'Empty': ['Empty']
        };
        var spawn_eggs;

        async function get_spawn_eggs() {
            const response = await fetch('https://raw.githubusercontent.com/misode/mcmeta/summary/registries/data.min.json');
            const data = await response.json();
            spawn_eggs = data.item.filter((item) => /spawn_egg/.test(item));
        }

        document.addEventListener("DOMContentLoaded", async function () {
            // Initialize Monaco Editor
            load_editor().catch(console.error);

            if (!spawn_eggs) await get_spawn_eggs();
            const spawn_egg_list = document.getElementById('spawn_egg_list');

            spawn_eggs.forEach(spawn_egg => {
                let option = document.createElement('option');
                option.value = spawn_egg;
                spawn_egg_list.appendChild(option);
            });

            const categories = Object.keys(examplesByCategory).reverse();
            const authorSelect = document.getElementById('authorSelect');
            authorSelect.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.text = category;
                authorSelect.add(option);
            });
            authorSelect.addEventListener('change', update_Examples);
            document.getElementById("copyLink").addEventListener("click", selectText);
        });

        function createOneCommand(event) {
            const commands = editor.getValue().split('\n').filter(line => {
                return !(/^(#(?!.*(?:setup|command block|in chat|controller|manual)).*)$/i.test(line));
            })
            const facing = document.getElementById("facing").value;
            const command_blocks = [];
            const spawn_egg = document.getElementById("spawn_egg").checked;
            const spawn_egg_type = document.getElementById("spawn_egg_type").value || document.getElementById("spawn_egg_type").placeholder;

            let offset = [0, -2, 0];
            let type = "just_command";
            let temp_type, temp_activity, temp_condition;
            let condition = '';
            let activity = '1';
            let first_offset = false;
            switch (facing) {
                case '':
                    offset[0]--;
                    break;
                case 'facing=south':
                    offset[0]++;
                    break;
                case 'facing=west':
                    offset[2]++;
                    break;
                case 'facing=east':
                    offset[2]--;
                    break;
            }
            commands.reduce((acc, line, i, arr) => {
                line = line.trim();
                if (line.startsWith('#')) return 0;
                type = temp_type ? temp_type : type == "just_command" ? "just_command" : "chain_command_block";
                activity = temp_activity ? temp_activity : '1';
                condition = temp_condition ? temp_condition : '';
                temp_type = undefined;
                temp_activity = undefined;
                temp_condition = undefined;
                if (!line) {
                    acc++;
                    if (/^# (?:setup|command block|in chat|controller|manual)/i.test(arr[i + 1]) && type !== 'just_command') {
                        switch (facing) {
                            case '':
                                offset[0] = offset[0] - acc;
                                break;
                            case 'facing=south':
                                offset[0] = offset[0] + acc;
                                break;
                            case 'facing=west':
                                offset[2] = offset[2] + acc;
                                break;
                            case 'facing=east':
                                offset[2] = offset[2] - acc;
                                break;
                        }
                    }
                    return acc;
                } else if (/^# (in chat)/i.test(arr[i - 1])) {
                    if (type !== 'just_command')
                        type = 'just_command';
                } else if (/^# (setup)/i.test(arr[i - 1])) {
                    type = 'command_block';
                    condition = '';
                    activity = '1';
                    if (first_offset)
                        switch (facing) {
                            case '':
                                offset[0]--;
                                offset[2] = 0;
                                break;
                            case 'facing=south':
                                offset[0]++;
                                offset[2] = 0;
                                break;
                            case 'facing=west':
                                offset[2]++;
                                offset[0] = 0;
                                break;
                            case 'facing=east':
                                offset[2]--;
                                offset[0] = 0;
                                break;
                        }
                    first_offset = true;
                } else if (/^# (manual)/i.test(arr[i - 1])) {
                    type = 'command_block';
                    condition = '';
                    activity = '0';
                    if (first_offset)
                        switch (facing) {
                            case '':
                                offset[0]--;
                                offset[2] = 0;
                                break;
                            case 'facing=south':
                                offset[0]++;
                                offset[2] = 0;
                                break;
                            case 'facing=west':
                                offset[2]++;
                                offset[0] = 0;
                                break;
                            case 'facing=east':
                                offset[2]--;
                                offset[0] = 0;
                                break;
                        }
                    first_offset = true;
                } else if (/^# (command block)|(controller)/i.test(arr[i - 1])) {
                    type = 'repeating_command_block';
                    condition = '';
                    activity = '1';
                    if (first_offset)
                        switch (facing) {
                            case '':
                                offset[0]--;
                                offset[2] = 0;
                                break;
                            case 'facing=south':
                                offset[0]++;
                                offset[2] = 0;
                                break;
                            case 'facing=west':
                                offset[2]++;
                                offset[0] = 0;
                                break;
                            case 'facing=east':
                                offset[2]--;
                                offset[0] = 0;
                                break;
                        }
                    first_offset = true;
                } else if (type !== "just_command")
                    switch (facing) {
                        case '':
                            offset[2]--;
                            break;
                        case 'facing=south':
                            offset[2]++;
                            break;
                        case 'facing=west':
                            offset[0]--;
                            break;
                        case 'facing=east':
                            offset[0]++;
                            break;
                    }
                line = line.replace(/^\//, '');
                let settings, redstone, sign, pos_x, pos_z, misc_facing;
                if (/^(\[.*?\])+(.*)$/.test(line)) {
                    let options = line.split(' ')[0].match(/\[([^\]]+)\]/g).map(option => option.replace(/[\[\]]/g, ''));
                    line = line.match(/^(\[.*?\])+(.*)$/)[2].trim();
                    settings, sign = false;
                    options.forEach((option) => {
                        if (/^[RCI][UC][AN]$/i.test(option)) {
                            settings = option;
                            type = settings[0];
                            condition = settings[1];
                            activity = settings[2];
                        } else if (/(button)|(lever)/i.test(option)) {
                            activity = '0';
                            switch (facing) {
                                case '':
                                    misc_facing = 'facing=south';
                                    pos_x = offset[0];
                                    pos_z = offset[2];
                                    break;
                                case 'facing=south':
                                    misc_facing = '';
                                    pos_x = offset[0];
                                    pos_z = offset[2];
                                    break;
                                case 'facing=west':
                                    misc_facing = 'facing=east';
                                    pos_x = offset[0];
                                    pos_z = offset[2];
                                    break;
                                case 'facing=east':
                                    misc_facing = 'facing=west';
                                    pos_x = offset[0];
                                    pos_z = offset[2];
                                    break;
                            }
                            command_blocks.push({ type: 'redstone', command: `~${pos_x} ~-1 ~${pos_z} ${option === 'button' ? 'stone_button' : option}[face=floor,${misc_facing}]` });
                        } else if (/(sign)/i.test(option)) {
                            switch (facing) {
                                case '':
                                    misc_facing = 'facing=south';
                                    pos_x = offset[0];
                                    pos_z = ++offset[2];
                                    break;
                                case 'facing=south':
                                    misc_facing = '';
                                    pos_x = offset[0];
                                    pos_z = --offset[2];
                                    break;
                                case 'facing=west':
                                    misc_facing = 'facing=east';
                                    pos_x = ++offset[0];
                                    pos_z = offset[2];
                                    break;
                                case 'facing=east':
                                    misc_facing = 'facing=west';
                                    pos_x = --offset[0];
                                    pos_z = offset[2];
                                    break;
                            }
                            temp_type = type;
                            temp_condition = condition;
                            temp_activity = activity;
                            type = 'sign';
                            let sign_lines = line.split('|');
                            sign_lines.forEach((sign_line, i, arr) => {
                                try {
                                    sign_lines[i] = JSON.parse(sign_line.trim())
                                } catch {
                                    sign_lines[i] = `'"${sign_line.trim()}"'`
                                }
                                while (sign_lines.length < 4)
                                    sign_lines.push(`'""'`)
                            })
                            line = `~${pos_x} ~-2 ~${pos_z} ${option === 'sign' ? 'oak_wall_sign' : option.replace('_', '_wall_')}[${misc_facing}]{front_text:{messages:[${sign_lines}]}}`;
                            delete arr[i - 1];
                        } else if (/(wool)/i.test(option)) {
                            activity = '0';
                            switch (facing) {
                                case '':
                                    misc_facing = 'facing=south';
                                    pos_x = offset[0];
                                    pos_z = offset[2]--;
                                    break;
                                case 'facing=south':
                                    misc_facing = '';
                                    pos_x = offset[0];
                                    pos_z = offset[2]++;
                                    break;
                                case 'facing=west':
                                    misc_facing = 'facing=east';
                                    pos_x = offset[0]--;
                                    pos_z = offset[2];
                                    break;
                                case 'facing=east':
                                    misc_facing = 'facing=west';
                                    pos_x = offset[0]++;
                                    pos_z = offset[2];
                                    break;
                            }
                            command_blocks.push({ type: 'redstone', command: `~${pos_x} ~-3 ~${pos_z} command_block{Command:\\"setblock ~ ~1 ~ ${option === 'wool' ? 'white_wool' : option}\\"}` });
                        }
                    })
                    if (settings) {
                        switch (type.toUpperCase()) {
                            case 'R':
                                type = 'repeating_command_block';
                                break;
                            case 'C':
                                type = 'chain_command_block';
                                break;
                            case 'I':
                                type = 'command_block';
                                break;
                            default:
                                alert(`Unknown type character: ${type} in ${settings}.`);
                                throw new Error(`Unknown type character: ${type}`);
                        }
                        switch (condition.toUpperCase()) {
                            case 'U':
                                condition = '';
                                break;
                            case 'C':
                                condition = 'conditional=true';
                                break;
                            default:
                                alert(`Unknown condition character: ${condition} in ${settings}.`);
                                throw new Error(`Unknown condition character: ${condition}`);
                        }
                        switch (activity.toUpperCase()) {
                            case 'A':
                                activity = '1';
                                break;
                            case 'N':
                                activity = '0';
                                break;
                            default:
                                alert(`Unknown activity character: ${activity} in ${settings}.`);
                                throw new Error(`Unknown activity character: ${activity}`);
                        }
                    }
                }
                command = line.replace(/@(.)/, (match, nextChar) => nextChar === 's' ? '@p' : match);
                command_blocks.push({ type: type, command: command.replace(/\\/g, '\\\\').replace(/"/g, '\\"'), condition: condition, activity: activity, offset: [...offset], redstone: { x: pos_x, z: pos_z, type: redstone, redstone_facing: misc_facing } });
                return 0;
            }, 0);
            let minecarts = [];
            let length = 128 + (131 + spawn_egg_type.length) * spawn_egg;

            command_blocks.push({ command: `fill ~ ~ ~ ~ ~-3 ~ air`, type: "command_block", condition: '', activity: "1", offset: [0, 1, 0] });
            command_blocks.push({ command: "execute align xyz run kill @e[type=command_block_minecart,dy=0]", type: "just_command", offset: [0, 0, 0] });
            command_blocks.forEach((cb) => {
                if (cb.type === "just_command")
                    minecarts.push(`{id:command_block_minecart,Command:"${cb.command}"}`);
                else if (cb.type === "redstone") {
                    minecarts.push(`{id:command_block_minecart,Command:"setblock ${cb.command}"}`);
                } else if (cb.type === "sign") {
                    minecarts.push(`{id:command_block_minecart,Command:"setblock ${cb.command}"}`);
                } else if (cb.type === "wool") {
                    minecarts.push(`{id:command_block_minecart,Command:"setblock ${cb.command}"}`);
                } else
                    minecarts.push(`{id:command_block_minecart,Command:"setblock ~${cb.offset[0] !== 0 ? cb.offset[0] : ''} ~${cb.offset[1] !== 0 ? cb.offset[1] : ''} ~${cb.offset[2] !== 0 ? cb.offset[2] : ''} ${cb.type}${facing || cb.condition ? '[' : ''}${facing}${facing && cb.condition ? ',' : ''}${cb.condition}${facing || cb.condition ? ']' : ''}{Command:\\"${cb.command.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}\\"${cb.activity === '1' ? ',auto:1' : ''}}"}`);
                length += minecarts[minecarts.length - 1].length;
            })
            if (length + 335 + patreonsFormat.length < 32500 && !event.shiftKey && !(spawn_egg && minecarts.length < 5)) {
                minecarts.splice(0, 0, `{id:command_block_minecart,Command:'tellraw @p [{"text":"Thanks for using Command Block Assembler! \\\\nAlso thanks to ${patreonsFormat} for their support on ","color":"green"},{"text":"Patreon","color":"gold","clickEvent":{"action":"open_url","value":"https://patreon.com/GalSergey"},"hoverEvent":{"action":"show_text","value":"Go to Patreon"}},"."]'}`)
            }
            let output = `summon falling_block ~ ~1 ~ {BlockState:{Name:redstone_block},Passengers:[{id:falling_block,BlockState:{Name:activator_rail}},${minecarts}]}`;
            if (spawn_egg) {
                output = `give @p ${spawn_egg_type}[entity_data={id:"minecraft:falling_block",DropItem:0,BlockState:{Name:"minecraft:command_block"},TileEntityData:{Command:"${output.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}",auto:1}}]`
            }
            if (output.length > 32500)
                alert('The generated command is too long to be used in a command block :(')
            document.getElementById("Output").value = output;

        }

        // Storage functions for command blocks
        function setStorage(key, value) {
            storage(key, value, 'command_blocks');
        }

        function getStorage(key) {
            return storage(key, undefined, 'command_blocks');
        }

        let textarea = document.getElementById('myInput');
        let inputFields = document.querySelectorAll('input, textarea');
        inputFields.forEach((inputField) => {
            inputField.addEventListener('input', handleInputChange);
            const storedValue = getStorage(inputField.id);
            if (storedValue !== null) {
                inputField.value = storedValue;
            }
        });

        let storedTextareaValue = getStorage('myInput');
        if (storedTextareaValue !== null) {
            textarea.value = storedTextareaValue;
        }

        function resetValues() {
            if (confirm("Are you sure you want to reset to default values?")) {
                var copyLink = document.querySelector(".copyLink");
                copyLink.style.display = 'none';
                const inputFields = document.querySelectorAll('input, textarea, select, .code-input');
                editor.setValue('');
                inputFields.forEach((inputField) => {
                    if (/exampleSelect|facing|authorSelect/.test(inputField.id)) return;
                    inputField.value = inputField.defaultValue;
                    localStorage.setItem("command_blocks", '{}');
                    setStorage(inputField.id || inputField.name, inputField.defaultValue);
                });
            }
        }

        function handleInputChange(event) {
            document.querySelector(".copyLink").style.display = "none"
            const inputField = event.target;
            const inputId = inputField.id || inputField.name;
            const inputValue = inputField.value;
            if (inputId === "myInput")
                placeholder.style.display = inputValue ? 'none' : 'block';
            setStorage(inputId, inputValue);
        }

        function selectText(event) {
            var copyLink = document.getElementById("copyLink");
            var link = copyLink.value.replace(/ /g, '_')
            if (event.shiftKey) {
                link = `You can use [Command Block Assembler](${link}) to get One Command Creation.`
            } else if (event.ctrlKey) {
                const text = editor.getValue().split('\n').join('\n    ');
                link = `\n\n    ${text}\n\nYou can use [Command Block Assembler](${link}) to get One Command Creation.`
            } else if (event.altKey) {
                const text = editor.getValue();
                link = `\n\`\`\`\n${text}\n\`\`\`\nYou can use [Datapack Assembler](${link}) to get an example datapack.`
            }

            const clipboard = new ClipboardJS('.copyLink', {
                text: function () {
                    return link;
                }
            });
            setTimeout(function () {
                copyLink.select();
            }, 100);
        }

        function update_Examples() {
            const selectedCategory = document.getElementById('authorSelect').value;
            const examples = examplesByCategory[selectedCategory];

            const exampleSelect = document.getElementById('exampleSelect');
            exampleSelect.innerHTML = '';
            const recent = Date.now() - 31 * 24 * 60 * 60 * 1000;

            Object.keys(examples).forEach((example) => {
                const option = document.createElement('option');
                option.text = `${examples[example].name} ${examples[example].date > recent ? '[NEW]' : ''}`;
                option.value = example;
                exampleSelect.add(option);
            })
        }

        async function loadExample(event, category, example) {
            example = document.getElementById('exampleSelect').value.replace(/ /g, '_');
            const shareLink = `${window.location.origin}/cba/?share=${example}`;
            if (event.shiftKey) {
                const category = document.getElementById('authorSelect').value.replace(/ /g, '_');

                const clipboard = new ClipboardJS('.load-example', {
                    text: function () {
                        return shareLink;
                    }
                });
            } else {
                if (editor.getValue()) {
                    var isConfirmed = confirm("You are sure you want to open an example? The entered data will be replaced.");
                    if (!isConfirmed) return false;
                };
                window.location.href = shareLink;
            };
            inputFields.forEach((inputField) => {
                setStorage(inputField.id, inputField.value);
            })
        }

        function update_authorSelect() {
            const categories = Object.keys(examplesByCategory).reverse();
            const authorSelect = document.getElementById('authorSelect');

            authorSelect.innerHTML = '';

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.text = category;
                authorSelect.add(option);
            })
        }

        fetch(`/get/library`)
            .then(response => response.json())
            .then(data => {
                examplesByCategory = data.command_blocks;
                update_authorSelect();
                update_Examples();
            })
            .catch(error => console.error('Error loading example:', error));

        var awaitLink = false;
        async function sendShare(event) {
            var shareButton = document.querySelector('.share-button');
            var copyLink = document.querySelector(".copyLink");

            if (awaitLink) return;
            var text = editor.getValue();
            if (!text) {
                alert("Please fill in all fields.");
                return;
            }
            awaitLink = true;
            shareButton.style.cursor = "wait";

            const hash = CryptoJS.SHA1(text.replace(/\r/g, '')).toString();
            if (!getHash(hash)) {
                await fetch(`/cba/share/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text }),
                })
                    .then(response => response.json())
                    .then(data => {
                        setHash(hash, `${window.location.origin}/cba/?share=${data.share}`);
                    })
                    .catch(error => {
                        console.error('Error creating paste:', error);
                    });
            }
            copyLink.value = getHash(hash);
            copyLink.style.display = "initial";
            copyLink.addEventListener("animationstart", function (e) {
                if (e.animationName === "fade-in") {
                    e.target.classList.add("did-fade-in");
                }
            })
            shareButton.style.cursor = "pointer";
            awaitLink = false;
        }

        function loadShare(share) {
            fetch(`/cba/share/get`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fileID: share,
                })
            })
                .then(response => response.json())
                .then(data => {
                    editor.setValue(data.content);
                    handleInputChange({ target: document.getElementById('myInput') });
                    inputFields.forEach((inputField) => {
                        setStorage(inputField.id, inputField.value);
                    });
                    const hash = CryptoJS.SHA1(data.content.replace(/\r/g, '')).toString();
                    setHash(hash, `${window.location.origin}/cba/?share=${share}`);
                })
                .catch(error => {
                    console.error('Error loading paste: ', error);
                });
        }

        function importCommands() {
            let enter_text = prompt("Enter One Command [WIP]:", document.getElementById("Output").value);
            if (enter_text) {

                let mode, x, z, blockType, command, auto;
                let offset = 1;
                let lines = [];
                enter_text = enter_text.substring(enter_text.indexOf('{'))
                let commands = enter_text.match(/Command:"((?:\\"|[^"])*)"/g);
                commands = commands?.map(s => s.slice(9, -1).replace(/\\"/g, '"'));
                commands.splice(-2);
                commands.forEach(cmd => {
                    if (!mode) {
                        log(cmd);
                        if (!cmd.startsWith("setblock")) {
                            lines.push("# In chat");
                            lines.push(cmd + '\n');
                            mode = "chat";
                        } else {
                            lines.push("# Command blocks");
                            mode = "command_block";
                            ({ x, z, blockType, conditional, auto, command } = commandParse(cmd));
                            lines.push(`[${blockType}${conditional}${auto}] ${command}`);
                        }
                    } else if (mode == "command_block" && !cmd.startsWith("setblock")) {
                        lines.push("# In chat");
                        lines.push(cmd + '\n');
                        mode = "chat";
                    } else if (mode === "chat" && cmd.startsWith("setblock")) {
                        lines.push("# Command blocks");
                        mode = "command_block";
                        ({ x, z, blockType, command, auto } = commandParse(cmd));
                        lines.push(`[${blockType}${conditional}${auto}] ${command}`);
                    } else if (mode === "chat") {
                        lines.push(cmd + '\n');
                    } else if (mode == "command_block") {
                        if (/setblock ~.* ~-1 ~.* .*_button\[face=floor.*\]/.test(cmd)) {
                            lines.push('[button]')
                        } else {
                            ({ x, z, blockType, conditional, auto, command } = commandParse(cmd));
                            lines.push(`[${blockType}${conditional}${auto}] ${command}`);
                        }
                    }
                });
                console.log(lines);

                function commandParse(cmd) {
                    const coordMatch = cmd.match(/~(-?\d*)\s+~(-?\d*)\s+~(-?\d*)?/);
                    const x = coordMatch?.[1] || '0';
                    const z = coordMatch?.[3] || '0';
                    const command_blockMatch = cmd.match(/\b(repeating_command_block|chain_command_block|command_block)(\[[^\]]*\])?/);
                    let command_blockType = null;
                    if (command_blockMatch?.[1]) {
                        switch (command_blockMatch[1]) {
                            case "repeating_command_block": command_blockType = "R"; break;
                            case "chain_command_block": command_blockType = "C"; break;
                            case "command_block": command_blockType = "I"; break;
                        }
                    }
                    let conditional = "A";
                    if (command_blockMatch?.[2]) {
                        const props = command_blockMatch[2];
                        if (/conditional\s*=\s*true/.test(props)) {
                            conditional = "C";
                        }
                    }
                    const commandMatch = cmd.match(/Command:"((?:\\.|[^"\\])*)"/);
                    const command = commandMatch?.[1].replace(/\\"/g, '"') || null;

                    const autoMatch = cmd.match(/auto\s*:\s*(\d)/);
                    const auto = autoMatch && parseInt(autoMatch[1], 10) === 1 ? "A" : "N";

                    log("x:", x, " z:", z, "[", command_blockType, conditional, auto, "] command:", command);
                    return ({ x, z, blockType: command_blockType, conditional, command, auto })
                }
            }
        }
    </script>

    <style>
        .blueprint-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4a9eff, #2d7ad6);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(74, 158, 255, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .blueprint-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 158, 255, 0.6);
        }

        .blueprint-link i {
            font-size: 16px;
        }
    </style>

    <!-- Open in Blueprint Button -->
    <a href="./blueprint.html" class="blueprint-link" id="blueprintLink" title="Open in Blueprint Editor">
        <span>üìê</span>
        <span>Open in Blueprint</span>
    </a>

    <script>
        // =============================================
        // SEAMLESS CBA-BLUEPRINT SYNC via SyncManager
        // =============================================

        let isExternalUpdate = false;

        // Initialize cross-tab sync
        function initSeamlessSync() {
            if (!window.syncManager) {
                console.warn('[Sync] SyncManager not available');
                return;
            }

            // Listen for external changes (from Blueprint or other tabs)
            syncManager.subscribe((state, source) => {
                if (source === 'external' && state && state.lastEditor === 'blueprint') {
                    // Blueprint made changes - update our editor
                    isExternalUpdate = true;
                    const currentValue = editor.getValue();
                    if (state.commands && state.commands !== currentValue) {
                        editor.setValue(state.commands);
                        showSyncNotification('Synced from Blueprint');
                    }
                    isExternalUpdate = false;
                }
            });

            // Show sync status indicator
            showSyncIndicator();
        }

        // Show sync indicator
        function showSyncIndicator() {
            let indicator = document.getElementById('syncIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'syncIndicator';
                indicator.className = 'sync-status-indicator';
                indicator.innerHTML = 'üîÑ Synced';
                document.body.appendChild(indicator);
            }
        }

        // Flash notification when sync happens
        function showSyncNotification(message) {
            const indicator = document.getElementById('syncIndicator');
            if (indicator) {
                indicator.innerHTML = '‚ú® ' + message;
                indicator.classList.add('syncing');
                setTimeout(() => {
                    indicator.innerHTML = 'üîÑ Synced';
                    indicator.classList.remove('syncing');
                }, 1500);
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initSeamlessSync, 500);
        });
    </script>

    <style>
        .sync-status-indicator {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(74, 158, 255, 0.9);
            color: white;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sync-status-indicator.syncing {
            background: rgba(76, 175, 80, 0.9);
            transform: scale(1.1);
        }
    </style>
</body>

</html>